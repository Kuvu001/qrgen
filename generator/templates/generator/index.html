{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>QR Code Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
</head>
<body class="bg-light">
    <div class="container py-4">
        <header class="mb-4 text-center">
            <h1 class="display-5 fw-bold">QR Code Generator</h1>
            <button id="themeToggle" class="btn btn-sm btn-outline-secondary mt-2">Toggle Dark Mode</button>
        </header>

        {% if error %}
        <div class="alert alert-danger" role="alert">
            {{ error }}
        </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" id="qrForm" action="{% url 'generator:generate_qr' %}" class="card p-4 mb-4 shadow-sm bg-white rounded">
            {% csrf_token %}
            <ul class="nav nav-tabs mb-3" id="qrTypeTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text" type="button" role="tab" aria-controls="text" aria-selected="true" data-type="text">Text</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="link-tab" data-bs-toggle="tab" data-bs-target="#link" type="button" role="tab" aria-controls="link" aria-selected="false" data-type="link">Link / URL</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="phone-tab" data-bs-toggle="tab" data-bs-target="#phone" type="button" role="tab" aria-controls="phone" aria-selected="false" data-type="phone">Phone</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button" role="tab" aria-controls="email" aria-selected="false" data-type="email">Email</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="wifi-tab" data-bs-toggle="tab" data-bs-target="#wifi" type="button" role="tab" aria-controls="wifi" aria-selected="false" data-type="wifi">WiFi Login</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="image-tab" data-bs-toggle="tab" data-bs-target="#image" type="button" role="tab" aria-controls="image" aria-selected="false" data-type="image">Image Upload</button>
                </li>
            </ul>

            <input type="hidden" name="qr_type" id="qrTypeInput" value="text" />

            <div class="tab-content" id="qrTypeContent">
                <div class="tab-pane fade show active" id="text" role="tabpanel" aria-labelledby="text-tab">
                    <div class="mb-3">
                        <label for="textInput" class="form-label">Text</label>
                        <textarea name="text" id="textInput" class="form-control form-control-lg" rows="3" placeholder="Enter any text"></textarea>
                    </div>
                </div>
                <div class="tab-pane fade" id="link" role="tabpanel" aria-labelledby="link-tab">
                    <div class="mb-3">
                        <label for="linkInput" class="form-label">Link / URL</label>
                        <input type="url" name="link" id="linkInput" class="form-control form-control-lg" placeholder="https://example.com" />
                    </div>
                </div>
                <div class="tab-pane fade" id="phone" role="tabpanel" aria-labelledby="phone-tab">
                    <div class="mb-3">
                        <label for="phoneInput" class="form-label">Phone Number</label>
                        <input type="tel" name="phone" id="phoneInput" class="form-control form-control-lg" placeholder="+1234567890" />
                    </div>
                </div>
                <div class="tab-pane fade" id="email" role="tabpanel" aria-labelledby="email-tab">
                    <div class="mb-3">
                        <label for="emailInput" class="form-label">Email Address</label>
                        <input type="email" name="email" id="emailInput" class="form-control form-control-lg" placeholder="example@domain.com" />
                    </div>
                </div>
                <div class="tab-pane fade" id="wifi" role="tabpanel" aria-labelledby="wifi-tab">
                    <div class="mb-3">
                        <label for="wifiSsid" class="form-label">WiFi SSID</label>
                        <input type="text" name="wifi_ssid" id="wifiSsid" class="form-control form-control-lg" placeholder="WiFi Network Name" />
                    </div>
                    <div class="mb-3">
                        <label for="wifiPassword" class="form-label">WiFi Password</label>
                        <input type="text" name="wifi_password" id="wifiPassword" class="form-control form-control-lg" placeholder="Password" />
                    </div>
                    <div class="mb-3">
                        <label for="wifiEncryption" class="form-label">Encryption</label>
                        <select name="wifi_encryption" id="wifiEncryption" class="form-select form-select-lg">
                            <option value="WPA" selected>WPA/WPA2</option>
                            <option value="WEP">WEP</option>
                            <option value="nopass">None</option>
                        </select>
                    </div>
                </div>
                <div class="tab-pane fade" id="image" role="tabpanel" aria-labelledby="image-tab">
                    <div class="mb-3">
                        <label for="uploadImage" class="form-label">Upload Image</label>
                        <input type="file" name="upload_image" id="uploadImage" class="form-control form-control-lg" accept="image/*" />
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg fw-bold">Generate QR Code</button>
            </div>
        </form>

        {% if qr_url %}
        <div class="card mb-4 bg-white shadow-sm rounded text-center p-4">
            <img src="{{ qr_url }}" alt="Generated QR Code" class="img-fluid mb-3" style="max-width: 300px; height: auto;" />
            <div>
                <a href="{% url 'generator:download_qr' qr_filename %}" class="btn btn-success btn-lg fw-bold me-2" download>Download QR Code</a>
                <button id="shareBtn" class="btn btn-outline-primary btn-lg fw-bold">Share QR Code</button>
            </div>
        </div>
        {% endif %}

        {% if qr_history %}
        <section>
            <h2 class="h4 mb-3">QR Codes History (Session)</h2>
            <div class="row row-cols-2 row-cols-md-4 g-3">
                {% for qr in qr_history %}
                <div class="col">
                    <div class="card shadow-sm">
                        <img src="{{ qr.qr_url }}" class="card-img-top" alt="QR Code" />
                        <div class="card-body p-2 text-center">
                            <a href="{% url 'generator:download_qr' qr.filename %}" class="btn btn-sm btn-outline-success w-100" download>Download</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function () {
            // Theme toggle handler
            const themeToggleBtn = document.getElementById('themeToggle');
            const htmlEl = document.documentElement;

            // Initialize theme from server-side
            const currentTheme = "{{ theme|default:'light' }}";
            if (currentTheme === 'dark') {
                htmlEl.setAttribute('data-theme', 'dark');
                document.body.classList.remove('bg-light');
                document.body.classList.add('bg-dark', 'text-light');
            }

            themeToggleBtn.addEventListener('click', function () {
                fetch("{% url 'generator:toggle_theme' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    credentials: 'same-origin',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.theme === 'dark') {
                        htmlEl.setAttribute('data-theme', 'dark');
                        document.body.classList.remove('bg-light');
                        document.body.classList.add('bg-dark', 'text-light');
                    } else {
                        htmlEl.setAttribute('data-theme', 'light');
                        document.body.classList.remove('bg-dark', 'text-light');
                        document.body.classList.add('bg-light');
                    }
                });
            });

            // QR type tabs sync to hidden input
            const tabs = document.querySelectorAll('#qrTypeTabs button.nav-link');
            const qrTypeInput = document.getElementById('qrTypeInput');

            tabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (event) {
                    qrTypeInput.value = event.target.getAttribute('data-type');
                });
            });

            // Share button functionality
            const shareBtn = document.getElementById('shareBtn');
            if (shareBtn && navigator.share) {
                shareBtn.style.display = 'inline-block';
                shareBtn.addEventListener('click', function () {
                    const qrUrl = "{{ qr_url }}";
                    navigator.share({
                        title: 'QR Code',
                        url: qrUrl
                    }).catch(console.error);
                });
            } else if (shareBtn) {
                shareBtn.style.display = 'none';
            }
        })();
    </script>
</body>
</html>
